# File: environments/production/prometheus-network-policy.yaml

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-prometheus-scrape
  namespace: phoenix-production # CRITICAL: Policy applies to this namespace
spec:
  # This selector targets all pods that need to be scraped (all apps in the namespace)
  podSelector: {}
  policyTypes:
    - Ingress
  ingress:
    # 1. Allow traffic from Istio ingress gateway
    - from:
      - namespaceSelector:
          matchLabels:
            name: istio-ingress
    # 2. Allow traffic within the same namespace (for inter-service communication)
    - from:
      - podSelector: {}
    # 3. Allow Prometheus scraping from monitoring namespace on port 15020
    - from:
      - namespaceSelector:
          matchLabels:
            name: monitoring
      ports:
        - protocol: TCP
          port: 15020
