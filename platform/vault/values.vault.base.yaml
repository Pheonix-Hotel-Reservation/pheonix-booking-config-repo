# -----------------------------------------------------------------
# GLOBAL SETTINGS
# -----------------------------------------------------------------
ui:
  enabled: true

injector:
  enabled: true

# Enable Prometheus metrics (optional, keep false if you don't have monitoring yet)
metrics:
  enabled: false

# -----------------------------------------------------------------
# SERVER CONFIGURATION
# -----------------------------------------------------------------
server:
  image:
    repository: hashicorp/vault
    tag: "1.20.4"

  # Resource limits (kept small for dev/test)
  resources:
    requests:
      cpu: "100m"
      memory: "256Mi"
    limits:
      cpu: "500m"
      memory: "512Mi"

  config: |
      ui = true

      listener "tcp" {
        tls_disable = 1
        address = "[::]:8200"
        cluster_address = "[::]:8201"
      }

      # Raft Storage Backend
      storage "raft" {
        path = "/vault/data"
        
        # Retry Join allows pods to find the leader automatically
        retry_join {
          leader_api_addr = "http://platform-vault-0.platform-vault-internal:8200"
        }
        retry_join {
          leader_api_addr = "http://platform-vault-1.platform-vault-internal:8200"
        }
        retry_join {
          leader_api_addr = "http://platform-vault-2.platform-vault-internal:8200"
        }
      }

      service_registration "kubernetes" {}

      # AWS KMS Auto-Unseal
      seal "awskms" {
        # Credentials are read automatically from ENV vars defined above
      }
  # 1. STORAGE (DigitalOcean)
  # This creates the PVCs. Critical for Raft to work.
  dataStorage:
    enabled: true
    size: 10Gi
    storageClass: "do-block-storage-retain" # Ensure this exists in your cluster
    accessMode: ReadWriteOnce

  # 2. SECRETS MAPPING
  # Maps the Kubernetes Secret (aws-kms-creds) to Env Vars for Vault
  extraSecretEnvironmentVars:
    - envName: AWS_ACCESS_KEY_ID
      secretName: aws-kms-creds
      secretKey: accessKeyID
    - envName: AWS_SECRET_ACCESS_KEY
      secretName: aws-kms-creds
      secretKey: secretAccessKey
    - envName: AWS_REGION
      secretName: aws-kms-creds
      secretKey: region
    - envName: VAULT_AWSKMS_SEAL_KEY_ID
      secretName: aws-kms-creds
      secretKey: kmsKeyId

  # 3. HIGH AVAILABILITY (Raft + KMS)
  ha:
    enabled: true
    replicas: 3
    
    # Enable Raft logic in the chart wrapper
    raft:
      enabled: true
      setNodeId: true

    # The actual HCL Configuration file
    
