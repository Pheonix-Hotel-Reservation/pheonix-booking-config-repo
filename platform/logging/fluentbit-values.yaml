# FluentBit Helm values
controller:
  env:
    - name: OPENSEARCH_PASS
      valueFrom:
        secretKeyRef:
          name: opensearch-admin-secret
          key: password

daemonset:
  enabled: true
  # Remove hostNetwork - not needed and creates security risks
  
service:
  type: ClusterIP

resources:
  limits:
    cpu: 200m
    memory: 200Mi
  requests:
    cpu: 100m
    memory: 100Mi

volumeMounts:
  - name: varlog
    mountPath: /var/log
    readOnly: true
  - name: containerd
    mountPath: /var/lib/containerd
    readOnly: true

volumes:
  - name: varlog
    hostPath:
      path: /var/log
  - name: containerd
    hostPath:
      path: /var/lib/containerd

config:
  inputs: |
    [INPUT]
        Name                tail
        Tag                 kube.*
        Path                /var/log/containers/*.log
        Parser              cri
        DB                  /var/log/flb_kube.db
        Mem_Buf_Limit       50MB
        Skip_Long_Lines     On
        Refresh_Interval    10
        Rotate_Wait         30

  filters: |
    [FILTER]
        Name                kubernetes
        Match               kube.*
        Kube_URL            https://kubernetes.default.svc:443
        Kube_CA_File        /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        Kube_Token_File     /var/run/secrets/kubernetes.io/serviceaccount/token
        Kube_Tag_Prefix     kube.var.log.containers.
        Merge_Log           On
        Merge_Log_Key       log_processed
        K8S-Logging.Parser  On
        K8S-Logging.Exclude On
        Annotations         Off
        Labels              On

    # Rewrite tags based on service name from Kubernetes labels
    [FILTER]
        Name                rewrite_tag
        Match               kube.*
        Rule                $kubernetes['labels']['app'] ^(user-service|hotel-service|room-service|reservation-service|search-service|notification-service|frontend)$ service.$1 false
        Emitter_Name        re_emitted
        Emitter_Storage.type memory
        Emitter_Mem_Buf_Limit 10M

  outputs: |
    # Per-service indices (logs still also go to the default index below)

    # User Service logs -> index: phoenix-user-service-YYYY.MM.DD
    [OUTPUT]
        Name                opensearch
        Match               service.user-service
        Host                opensearch-cluster-master.opensearch.svc.cluster.local
        Port                9200
        Index               phoenix-user-service-%Y.%m.%d
        Type                _doc
        Replace_Dots        On
        Retry_Limit         3
        HTTP_User           admin
        HTTP_passwd         ${OPENSEARCH_PASS}
        tls                 On
        tls.verify          Off
        Suppress_Type_Name  On
        Time_Key            @timestamp
        Time_Key_Format     %Y-%m-%dT%H:%M:%S.%L%z

    # Hotel Service logs -> index: phoenix-hotel-service-YYYY.MM.DD
    [OUTPUT]
        Name                opensearch
        Match               service.hotel-service
        Host                opensearch-cluster-master.opensearch.svc.cluster.local
        Port                9200
        Index               phoenix-hotel-service-%Y.%m.%d
        Type                _doc
        Replace_Dots        On
        Retry_Limit         3
        HTTP_User           admin
        HTTP_passwd         ${OPENSEARCH_PASS}
        tls                 On
        tls.verify          Off
        Suppress_Type_Name  On
        Time_Key            @timestamp
        Time_Key_Format     %Y-%m-%dT%H:%M:%S.%L%z

    # Room Service logs -> index: phoenix-room-service-YYYY.MM.DD
    [OUTPUT]
        Name                opensearch
        Match               service.room-service
        Host                opensearch-cluster-master.opensearch.svc.cluster.local
        Port                9200
        Index               phoenix-room-service-%Y.%m.%d
        Type                _doc
        Replace_Dots        On
        Retry_Limit         3
        HTTP_User           admin
        HTTP_passwd         ${OPENSEARCH_PASS}
        tls                 On
        tls.verify          Off
        Suppress_Type_Name  On
        Time_Key            @timestamp
        Time_Key_Format     %Y-%m-%dT%H:%M:%S.%L%z

    # Reservation Service logs -> index: phoenix-reservation-service-YYYY.MM.DD
    [OUTPUT]
        Name                opensearch
        Match               service.reservation-service
        Host                opensearch-cluster-master.opensearch.svc.cluster.local
        Port                9200
        Index               phoenix-reservation-service-%Y.%m.%d
        Type                _doc
        Replace_Dots        On
        Retry_Limit         3
        HTTP_User           admin
        HTTP_passwd         ${OPENSEARCH_PASS}
        tls                 On
        tls.verify          Off
        Suppress_Type_Name  On
        Time_Key            @timestamp
        Time_Key_Format     %Y-%m-%dT%H:%M:%S.%L%z

    # Search Service logs -> index: phoenix-search-service-YYYY.MM.DD
    [OUTPUT]
        Name                opensearch
        Match               service.search-service
        Host                opensearch-cluster-master.opensearch.svc.cluster.local
        Port                9200
        Index               phoenix-search-service-%Y.%m.%d
        Type                _doc
        Replace_Dots        On
        Retry_Limit         3
        HTTP_User           admin
        HTTP_passwd         ${OPENSEARCH_PASS}
        tls                 On
        tls.verify          Off
        Suppress_Type_Name  On
        Time_Key            @timestamp
        Time_Key_Format     %Y-%m-%dT%H:%M:%S.%L%z

    # Notification Service logs -> index: phoenix-notification-service-YYYY.MM.DD
    [OUTPUT]
        Name                opensearch
        Match               service.notification-service
        Host                opensearch-cluster-master.opensearch.svc.cluster.local
        Port                9200
        Index               phoenix-notification-service-%Y.%m.%d
        Type                _doc
        Replace_Dots        On
        Retry_Limit         3
        HTTP_User           admin
        HTTP_passwd         ${OPENSEARCH_PASS}
        tls                 On
        tls.verify          Off
        Suppress_Type_Name  On
        Time_Key            @timestamp
        Time_Key_Format     %Y-%m-%dT%H:%M:%S.%L%z

    # Frontend logs -> index: phoenix-frontend-YYYY.MM.DD
    [OUTPUT]
        Name                opensearch
        Match               service.frontend
        Host                opensearch-cluster-master.opensearch.svc.cluster.local
        Port                9200
        Index               phoenix-frontend-%Y.%m.%d
        Type                _doc
        Replace_Dots        On
        Retry_Limit         3
        HTTP_User           admin
        HTTP_passwd         ${OPENSEARCH_PASS}
        tls                 On
        tls.verify          Off
        Suppress_Type_Name  On
        Time_Key            @timestamp
        Time_Key_Format     %Y-%m-%dT%H:%M:%S.%L%z

    # Fallback index for everything else (and also still receives all logs, including service logs)
    [OUTPUT]
        Name                opensearch
        Match               *
        Host                opensearch-cluster-master.opensearch.svc.cluster.local
        Port                9200
        Index               kubernetes-logs-%Y.%m.%d
        Type                _doc
        Replace_Dots        On
        Retry_Limit         3
        HTTP_User           admin
        HTTP_passwd         ${OPENSEARCH_PASS}
        tls                 On
        tls.verify          Off
        Suppress_Type_Name  On
        Time_Key            @timestamp
        Time_Key_Format     %Y-%m-%dT%H:%M:%S.%L%z
