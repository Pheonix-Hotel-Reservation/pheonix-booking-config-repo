# Recommended RabbitMQ configuration for Microservices

# CRITICAL FIX: The Bitnami repository is no longer free/public on Docker Hub.
# Switching to the OFFICIAL Docker Library image, which is stable and free.
image:
  # Using the official public repository path: docker.io/library/rabbitmq
  repository: docker.io/library/rabbitmq
  # CRITICAL: Using the specified stable tag with management plugin on Alpine base
  tag: 4.1.6-management-alpine 
  pullPolicy: IfNotPresent
  
auth:
  enabled: true # Re-enable the built-in user creation logic
  existingSecret: rabbitmq # It will use this to get the password
  username: user

# Enable persistence (CRITICAL for production)
persistence:
  enabled: true
  storageClass: "default" # Use your cluster's default storage class
  size: 10Gi

# Enable the Management Plugin (for UI access and testing)
# We will use this to verify the queue is functioning.
metrics:
  enabled: true
  service:
    type: ClusterIP
    port: 15692 # Metrics port

ingress:
  enabled: false # Use Istio VirtualService for external access, not standard Ingress

# Resource limits (adjust based on load)
resources:
  requests:
    cpu: 250m
    memory: 512Mi
  limits:
    cpu: 500m
    memory: 1024Mi

extraInitContainers: |
  - name: rabbitmq-user-init
    image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
    imagePullPolicy: {{ .Values.image.pullPolicy }}
    env:
      # Inject credentials from the K8s Secret created by ESO
      - name: RABBITMQ_USER
        valueFrom:
          secretKeyRef:
            name: rabbitmq # Name of your K8s Secret
            key: rabbitmq-username # Key used in your ESO manifest
      - name: RABBITMQ_PASS
        valueFrom:
          secretKeyRef:
            name: rabbitmq # Name of your K8s Secret
            key: rabbitmq-password # Key used in your ESO manifest
    command: ["/bin/bash", "-c"]
    args:
      - |
        # Wait for the main RabbitMQ service to be running
        until rabbitmqctl status; do echo waiting for rabbitmq; sleep 5; done
        
        # 1. Add the user (this uses the credentials from the Secret)
        rabbitmqctl add_user $RABBITMQ_USER $RABBITMQ_PASS
        
        # 2. Set the management tags (CRITICAL for Web UI access)
        rabbitmqctl set_user_tags $RABBITMQ_USER administrator management
        
        # 3. Set the full permissions on the default virtual host
        rabbitmqctl set_permissions -p / $RABBITMQ_USER ".*" ".*" ".*"