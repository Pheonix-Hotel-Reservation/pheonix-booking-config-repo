apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "header-echo.fullname" . }}-config
  namespace: {{ .Release.Namespace }}
data:
  app.js: |
    const express = require('express');
    const app = express();
    
    app.get('*', (req, res) => {
      const timestamp = new Date().toISOString();
      console.log(`[${timestamp}] ${req.method} ${req.path}`);
      console.log('Headers:', JSON.stringify(req.headers, null, 2));
      
      res.json({
        timestamp: timestamp,
        method: req.method,
        path: req.path,
        headers: req.headers,
        jwt_debug: {
          'x-auth-user-id': req.headers['x-auth-user-id'] || 'MISSING',
          'x-auth-user-email': req.headers['x-auth-user-email'] || 'MISSING',
          'x-auth-user-groups': req.headers['x-auth-user-groups'] || 'MISSING',
          'authorization': req.headers['authorization'] ? 'PRESENT' : 'MISSING'
        }
      });
    });
    
    app.listen(3000, () => {
      console.log('Header echo service listening on port 3000');
      console.log('Use this service to debug JWT header forwarding');
    });
    
  package.json: |
    {
      "name": "header-echo",
      "version": "1.0.0",
      "main": "app.js",
      "dependencies": {
        "express": "^4.18.2"
      },
      "scripts": {
        "start": "node app.js"
      }
    }